<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button href="/tabs/adoption">
        <ion-icon size="medium" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Adoption Details</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showActionsPanel = true" aria-label="More actions">
        <ion-icon name="paw-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="pet-details-content">
  <div class="pet-details-card" *ngIf="pet">
    <!-- Header Row -->
    <div class="pet-header-row">
      <div class="pet-name-block">
        <h2>{{ pet?.petName || (pet?.species | titlecase) }}</h2>
        <div class="breed">{{ pet?.breed || pet?.species }}</div>

        <!-- Status chip -->
        <div class="status-chip" *ngIf="pet?.status" [class.adopted]="pet?.status==='Adopted'">
          {{ pet?.status }}
        </div>

        <div class="pet-meta">
          <ion-icon name="location-outline"></ion-icon>
          <span *ngIf="pet?.location">{{ pet.location }}</span>
          <span *ngIf="pet?.distanceKm">• {{ pet.distanceKm | number:'1.1-1' }} km away</span>
          <ion-button fill="clear" size="small" (click)="openInMaps()" *ngIf="pet?.location || (pet?.lat && pet?.lng)">
            <ion-icon name="map-outline" slot="start"></ion-icon>
            Open in Maps
          </ion-button>
        </div>

        <!-- Optional: show contact name if available -->
      </div>

      <div class="pet-age-sex">
        <span class="age" *ngIf="pet?.age !== undefined">{{ pet?.age }} months old</span>
        <ion-icon *ngIf="pet?.gender==='male'" name="male-outline" title="Male"></ion-icon>
        <ion-icon *ngIf="pet?.gender==='female'" name="female-outline" title="Female"></ion-icon>
      </div>
    </div>

    <!-- Gallery Section (with placeholder fallback) -->
    <ng-container *ngIf="photoList()?.length; else noPhoto">
      <div class="pet-gallery-section">
        <div class="pet-thumb-list">
          <img *ngFor="let photo of photoList() | slice:0:5; let idx=index"
               [src]="photo"
               [class.active-thumb]="idx === mainImageIdx"
               (click)="mainImageIdx = idx" />
        </div>
        <div class="pet-main-image">
          <img [src]="photoList()[mainImageIdx]" alt="Pet photo" />
        </div>
      </div>
    </ng-container>
    <ng-template #noPhoto>
      <div class="pet-gallery-section">
        <div class="pet-main-image">
          <img src="assets/default-pet.jpg" alt="Pet photo" />
        </div>
      </div>
    </ng-template>

    <!-- About Section -->
    <div class="about-section">
      <h3>About</h3>
      <p>{{ pet?.description || pet?.bio || 'No description available.' }}</p>

      <!-- Health + other tags -->
      <div class="tags-row" *ngIf="hasHealthTags || hasOtherTags">
        <ion-chip *ngIf="pet?.vaccinated" color="success" outline="true">Vaccinated</ion-chip>
        <ion-chip *ngIf="pet?.dewormed" outline="true">Dewormed</ion-chip>
        <ion-chip *ngIf="pet?.neutered" outline="true">Neutered</ion-chip>
        <ion-chip *ngFor="let t of pet?.tags" outline="true">{{ t | titlecase }}</ion-chip>
      </div>
    </div>

    <!-- Contact / Inquiry Section -->
    <div class="contact-section">
      <h3>Contact Owner</h3>

      <ion-item lines="full">
        <ion-textarea
          [(ngModel)]="inquiryMessage"
          placeholder="Write your inquiry to the owner…"
          autoGrow="true">
        </ion-textarea>
      </ion-item>

      <!-- Only allow contact when Active -->
      <div *ngIf="pet?.status === 'Active'; else notActive" class="contact-actions" style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.75rem;">
        <ion-button (click)="sendInquiry()" expand="block">
          <ion-icon name="send-outline" slot="start"></ion-icon>
          Send Inquiry
        </ion-button>

        <ion-button color="success" (click)="whatsappOwner()" expand="block" [disabled]="!canWhatsApp">
          <ion-icon name="logo-whatsapp" slot="start"></ion-icon>
          WhatsApp
        </ion-button>

        <ion-button color="tertiary" (click)="callOwner()" expand="block" [disabled]="!canCall">
          <ion-icon name="call-outline" slot="start"></ion-icon>
          Call
        </ion-button>
      </div>

      <ng-template #notActive>
        <ion-note color="medium" style="display:block; margin-top:.75rem;">
          This listing isn’t active, so contacting the owner is disabled.
        </ion-note>
      </ng-template>

      <!-- Privacy hint -->
      <small class="privacy-note" *ngIf="pet?.status === 'Active' && !canCall && !canWhatsApp"
             style="opacity:.7; display:block; margin-top:.25rem;">
        Owner contact isn’t public. Please use “Send Inquiry.”
      </small>

      <!-- Report incorrect info -->
      <ion-button fill="clear" size="small" (click)="reportPet()" style="margin-top:.25rem;">
        <ion-icon name="flag-outline" slot="start"></ion-icon>
        Report incorrect info
      </ion-button>
    </div>
  </div>
</ion-content>

<!-- Sliding Actions Panel -->
<div class="side-panel-backdrop" *ngIf="showActionsPanel" (click)="showActionsPanel = false"></div>
<div class="side-panel" *ngIf="showActionsPanel">
  <div class="side-panel-header">
    <ion-icon name="paw" class="main-paw"></ion-icon>
  </div>
  <div class="side-panel-actions">
    <ion-button fill="clear" (click)="callOwner()" class="side-icn" [disabled]="!canCall || pet?.status!=='Active'">
      <ion-icon name="call"></ion-icon>
    </ion-button>
    <ion-button fill="clear" (click)="whatsappOwner()" class="side-icn" [disabled]="!canWhatsApp || pet?.status!=='Active'">
      <ion-icon name="logo-whatsapp"></ion-icon>
    </ion-button>
    <ion-button fill="clear" (click)="sharePet()" class="side-icn">
      <ion-icon name="share-social"></ion-icon>
    </ion-button>
    <ion-button fill="clear" (click)="markAdopted()" class="side-icn">
      <ion-icon name="paw"></ion-icon>
    </ion-button>
  </div>
</div>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="toggleFavorite()" aria-label="Toggle favorite">
        <ion-icon [name]="pet?.favorite ? 'heart' : 'heart-outline'" color="danger"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button class="adopt-btn" (click)="sendInquiry()" [disabled]="pet?.status !== 'Active'">
        ADOPT
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
